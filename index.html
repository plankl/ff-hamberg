<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Hydrantenkarte Hamberg</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { box-sizing: border-box; }
    html, body { 
      margin: 0; 
      padding: 0; 
      height: 100vh; 
      width: 100vw;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    }
    
    #map-container { 
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      transition: transform 0.2s ease-out;
      transform-origin: center center;
    }
    
    #map { 
      width: 170%;
      height: 170%;
      position: absolute;
      top: -35%;
      left: -35%;
    }
    
    .controls-container { 
      position: fixed; 
      top: 10px; 
      right: 10px; 
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .control-btn { 
      background: rgba(255,255,255,0.95); 
      border: 1px solid #ddd;
      border-radius: 6px; 
      padding: 8px 12px; 
      cursor: pointer; 
      font-weight: 500; 
      font-size: 14px;
      min-width: 120px;
      text-align: center;
      backdrop-filter: blur(10px);
      transition: all 0.2s ease;
      user-select: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .control-btn:hover { background: rgba(240,240,240,0.95); }
    .control-btn:active { transform: scale(0.95); }
    .control-btn.active { background: #4CAF50; color: white; border-color: #45a049; }
    
    .emergency-btn { 
      background: #ff4444 !important; 
      color: white !important; 
      border-color: #cc0000 !important;
      font-weight: 600;
      animation: pulse 2s infinite;
    }
    
    .emergency-btn.active { 
      background: #cc0000 !important; 
      animation: flashEmergency 1s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(255, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); }
    }
    
    @keyframes flashEmergency {
      0%, 100% { background: #cc0000 !important; }
      50% { background: #ff6666 !important; }
    }
    
    .emergency-mode {
      filter: contrast(1.2) brightness(1.1);
    }
    
    .emergency-mode .control-btn {
      font-size: 16px !important;
      padding: 12px 16px !important;
      min-width: 140px !important;
    }
    
    .legend { 
      position: fixed; 
      bottom: 60px; 
      left: 10px; 
      background: rgba(255,255,255,0.95); 
      padding: 12px; 
      border-radius: 8px; 
      font-size: 13px; 
      z-index: 2000;
      max-width: 200px;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .legend div { margin: 6px 0; display: flex; align-items: center; }
    .legend-img { width: 18px; height: 18px; margin-right: 8px; }
    
    .status-indicators { 
      position: fixed; 
      bottom: 10px; 
      right: 10px; 
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .status-indicator { 
      background: rgba(255,255,255,0.95); 
      padding: 4px 8px; 
      border-radius: 4px; 
      font-size: 12px; 
      font-weight: 500;
      backdrop-filter: blur(10px);
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    
    .map-title { 
      position: fixed; 
      top: 10px; 
      left: 50%; 
      transform: translateX(-50%); 
      background: rgba(255, 255, 255, 0.95); 
      padding: 8px 16px; 
      font-size: 16px; 
      font-weight: 600; 
      border-radius: 8px; 
      z-index: 2000;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .footer-info { 
      position: fixed; 
      bottom: 10px; 
      left: 10px; 
      font-size: 11px; 
      background: rgba(255,255,255,0.9); 
      padding: 4px 8px; 
      border-radius: 4px; 
      z-index: 2000;
      backdrop-filter: blur(10px);
    }
    
    .leaflet-control-layers {
      position: fixed !important;
      top: 60px !important;
      left: 10px !important;
      right: auto !important;
      background: rgba(255,255,255,0.95) !important;
      backdrop-filter: blur(10px);
      border-radius: 8px !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
      border: 1px solid #ddd !important;
    }
    
    .leaflet-control-zoom {
      position: fixed !important;
      bottom: 120px !important;
      right: 10px !important;
      top: auto !important;
      left: auto !important;
      z-index: 2000 !important;
      background: rgba(255,255,255,0.95) !important;
      border-radius: 6px !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
    }
    
    .leaflet-control-zoom a {
      background: rgba(255,255,255,0.95) !important;
      border: 1px solid #ddd !important;
      color: #333 !important;
      font-size: 18px !important;
      font-weight: bold !important;
    }
    
    .leaflet-control-zoom a:hover {
      background: rgba(240,240,240,0.95) !important;
    }
    
    .leaflet-control-attribution {
      background: rgba(255,255,255,0.8) !important;
      backdrop-filter: blur(5px);
    }
    
    /* Popup-Rotation f√ºr bessere Lesbarkeit */
    .leaflet-popup {
      transition: transform 0.2s ease-out;
      transform-origin: 50% 100%;
    }
    
    .leaflet-popup.stay-open {
      pointer-events: auto !important;
    }
    
    .leaflet-popup-content-wrapper {
      background: rgba(255,255,255,0.95) !important;
      backdrop-filter: blur(10px);
      border-radius: 8px !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
    }
    
    .leaflet-popup-content {
      margin: 12px 16px !important;
      font-size: 13px;
      line-height: 1.4;
    }
    
    .leaflet-popup-tip {
      background: rgba(255,255,255,0.95) !important;
    }
    
    /* Marker-Rotation */
    .leaflet-marker-icon {
      transition: transform 0.2s ease-out;
    }
    
    .marker-rotated {
      transform-origin: 50% 100%;
    }
    
    @media (max-width: 768px) {
      .map-title { 
        font-size: 14px; 
        padding: 6px 12px;
        top: 5px;
      }
      
      .controls-container { 
        top: 5px; 
        right: 5px; 
        gap: 6px;
      }
      
      .control-btn { 
        padding: 6px 10px; 
        font-size: 12px; 
        min-width: 100px;
      }
      
      .legend { 
        bottom: 50px; 
        left: 5px; 
        padding: 8px;
        font-size: 12px;
        max-width: 180px;
      }
      
      .status-indicators { 
        bottom: 5px; 
        right: 5px; 
      }
      
      .footer-info { 
        bottom: 5px; 
        left: 5px; 
        font-size: 10px;
      }
      
      .leaflet-control-layers {
        top: 50px !important;
        left: 5px !important;
        font-size: 12px !important;
      }
      
      .leaflet-control-zoom {
        bottom: 100px !important;
        right: 5px !important;
      }
    }
    
    @media (max-width: 480px) {
      .controls-container { 
        top: 45px; 
        right: 5px; 
      }
      
      .map-title { 
        font-size: 12px; 
        padding: 4px 8px;
      }
      
      .control-btn { 
        padding: 5px 8px; 
        font-size: 11px; 
        min-width: 80px;
      }
      
      .leaflet-control-layers {
        top: 40px !important;
        left: 5px !important;
        font-size: 11px !important;
      }
    }
    
    @media (orientation: landscape) and (max-height: 600px) {
      .legend { 
        bottom: 10px; 
        left: 5px; 
        padding: 6px;
        font-size: 11px;
      }
      
      .controls-container { 
        top: 5px; 
        right: 5px; 
      }
      
      .leaflet-control-layers {
        top: 5px !important;
        left: 120px !important;
      }
      
      .leaflet-control-zoom {
        bottom: 80px !important;
        right: 5px !important;
      }
    }
  </style>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(console.error);
    }
  </script>
</head>
<body>
  <div id="map-container">
    <div id="map"></div>
  </div>
  
  <div class="map-title">Freiwillige Feuerwehr Hamberg ‚Äì Hydrantenkarte</div>
  
  <div class="controls-container">
    <div class="control-btn emergency-btn" onclick="toggleEmergencyMode()" id="emergency-toggle">üö® Notfall</div>
    <div class="control-btn" onclick="toggleFlashlight()" id="flashlight-toggle">üî¶ Licht</div>
    <div class="control-btn" onclick="findNearestHydrant()">üîç N√§chster</div>
    <div class="control-btn" onclick="toggleTheme()">üåì Theme</div>
    <div class="control-btn" onclick="requestOrientationPermissionIfNeeded()">üß≠ Kompass</div>
    <div class="control-btn" onclick="toggleMapRotation()" id="rotation-toggle">üîÑ Rotation</div>
    <div class="control-btn" onclick="gotoUserLocation()">üìç Position</div>
    <div class="control-btn" onclick="captureScreenshot()">üì∑ Screenshot</div>
  </div>
  
  <div class="legend">
    <div><img src="icons/red-dot.png" class="legend-img"> √úberflurhydrant</div>
    <div><img src="icons/blue-dot.png" class="legend-img"> Unterflurhydrant</div>
    <div><img src="icons/green-dot.png" class="legend-img"> Rettungspunkt</div>
    <div><img src="icons/yellow-dot.png" class="legend-img"> Wasserbeh√§lter</div>
    <div><img src="icons/purple-dot.png" class="legend-img"> Sperrpunkt</div>
  </div>
  
  <div class="status-indicators">
    <div class="status-indicator" id="degree-indicator">0¬∞</div>
    <div class="status-indicator" id="altitude-indicator">H√∂he: -- m</div>
    <div class="status-indicator" id="accuracy-indicator">GPS: -- m</div>
    <div class="status-indicator" id="compass-status">Kompass: Inaktiv</div>
    <div class="status-indicator" id="nearest-hydrant">N√§chster: -- m</div>
  </div>
  
  <div class="footer-info">Erstellt am 26.06.2025</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  var osmStandard = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
    attribution: '¬© OpenStreetMap contributors',
    maxZoom: 19
  });
  
  var osmDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', { 
    attribution: '¬© CartoDB, ¬© OpenStreetMap contributors',
    maxZoom: 19
  });
  
  var topoMap = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenTopoMap (CC-BY-SA), ¬© OpenStreetMap contributors',
    maxZoom: 17
  });
  
  var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: '¬© Esri, Maxar, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community',
    maxZoom: 18
  });
  
  var terrainMap = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.png', {
    attribution: '¬© Stamen Design, ¬© OpenStreetMap contributors',
    maxZoom: 16
  });

  var map = L.map('map', { 
    center: [49.10951, 11.68453], 
    zoom: 15, 
    layers: [osmStandard],
    zoomControl: true,
    attributionControl: true
  });

  var baseLayers = { 
    'Standard': osmStandard, 
    'Topografisch': topoMap,
    'Satellit': satellite,
    'Terrain': terrainMap,
    'Dunkel': osmDark
  };
  
  var layerControl = L.control.layers(baseLayers, null, {
    position: 'topleft',
    collapsed: true
  }).addTo(map);
  
  map.zoomControl.setPosition('bottomright');

  let userMarker, cone, accuracyCircle, nearestHydrantLine;
  let compassActive = false;
  let mapRotationEnabled = false;
  let emergencyMode = false;
  let flashlightActive = false;
  let flashlightStream = null;
  let currentHeading = 0;
  let currentAltitude = null;
  let currentAccuracy = null;
  let watchId = null;
  let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  let hydrantMarkers = [];
  let userPosition = null;
  let openPopup = null;

  function toggleTheme() {
    if (map.hasLayer(osmStandard)) { 
      map.removeLayer(osmStandard); 
      map.addLayer(osmDark); 
    }
    else if (map.hasLayer(osmDark)) { 
      map.removeLayer(osmDark); 
      map.addLayer(osmStandard); 
    }
  }

  function toggleMapRotation() {
    mapRotationEnabled = !mapRotationEnabled;
    const toggleBtn = document.getElementById('rotation-toggle');
    
    if (mapRotationEnabled) {
      toggleBtn.classList.add('active');
      toggleBtn.textContent = 'üîÑ Rotation AN';
      updateMapRotation();
    } else {
      toggleBtn.classList.remove('active');
      toggleBtn.textContent = 'üîÑ Rotation AUS';
      document.getElementById('map-container').style.transform = 'rotate(0deg)';
      updatePopupRotation(0); // Popups zur√ºcksetzen
      updateMarkerRotation(0); // Marker zur√ºcksetzen
      
      setTimeout(() => {
        if (map) {
          map.invalidateSize();
        }
      }, 300);
    }
    
    // Flashlight bleibt immer nach oben (Display-oben)
    if (cone && userMarker) {
      const userLatLng = userMarker.getLatLng();
      cone.setLatLngs(getConePoints([userLatLng.lat, userLatLng.lng], 0));
    }
  }

  // Taschenlampe-Funktionen
  async function toggleFlashlight() {
    const toggleBtn = document.getElementById('flashlight-toggle');
    
    try {
      if (!flashlightActive) {
        // Taschenlampe einschalten
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' }
        });
        
        const track = stream.getVideoTracks()[0];
        const capabilities = track.getCapabilities();
        
        if (capabilities.torch) {
          await track.applyConstraints({
            advanced: [{ torch: true }]
          });
          
          flashlightStream = stream;
          flashlightActive = true;
          toggleBtn.classList.add('active');
          toggleBtn.textContent = 'üî¶ AN';
          
          // Blinkmodus im Notfall
          if (emergencyMode) {
            startEmergencyFlash();
          }
        } else {
          throw new Error('Taschenlampe nicht verf√ºgbar');
        }
      } else {
        // Taschenlampe ausschalten
        if (flashlightStream) {
          const track = flashlightStream.getVideoTracks()[0];
          await track.applyConstraints({
            advanced: [{ torch: false }]
          });
          
          flashlightStream.getTracks().forEach(track => track.stop());
          flashlightStream = null;
        }
        
        flashlightActive = false;
        toggleBtn.classList.remove('active');
        toggleBtn.textContent = 'üî¶ Licht';
        
        // Blinkmodus stoppen
        stopEmergencyFlash();
      }
    } catch (error) {
      console.error('Taschenlampe-Fehler:', error);
      toggleBtn.textContent = 'üî¶ Fehler';
      
      // Fallback: Bildschirm-Taschenlampe
      toggleScreenFlashlight();
    }
  }

  let flashInterval = null;
  
  function startEmergencyFlash() {
    if (!flashlightStream || flashInterval) return;
    
    const track = flashlightStream.getVideoTracks()[0];
    let isOn = true;
    
    flashInterval = setInterval(async () => {
      try {
        await track.applyConstraints({
          advanced: [{ torch: isOn }]
        });
        isOn = !isOn;
      } catch (error) {
        console.error('Blink-Fehler:', error);
        stopEmergencyFlash();
      }
    }, 500); // Alle 500ms blinken
  }
  
  function stopEmergencyFlash() {
    if (flashInterval) {
      clearInterval(flashInterval);
      flashInterval = null;
    }
  }

  function toggleScreenFlashlight() {
    const flashlightDiv = document.getElementById('screen-flashlight') || 
      document.createElement('div');
    
    if (!document.getElementById('screen-flashlight')) {
      flashlightDiv.id = 'screen-flashlight';
      flashlightDiv.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: white; z-index: 10000; pointer-events: none;
        display: none;
      `;
      document.body.appendChild(flashlightDiv);
    }
    
    const toggleBtn = document.getElementById('flashlight-toggle');
    
    if (flashlightDiv.style.display === 'none') {
      flashlightDiv.style.display = 'block';
      toggleBtn.classList.add('active');
      toggleBtn.textContent = 'üì± Bildschirm';
    } else {
      flashlightDiv.style.display = 'none';
      toggleBtn.classList.remove('active');
      toggleBtn.textContent = 'üî¶ Licht';
    }
  }

  function updateMapRotation() {
    if (mapRotationEnabled) {
      const mapContainer = document.getElementById('map-container');
      // Karte dreht sich entgegengesetzt zum Kompass, damit Ger√§terichtung nach oben zeigt
      let rotationAngle = -currentHeading;
      mapContainer.style.transform = `rotate(${rotationAngle}deg)`;
      
      // Popups entgegengesetzt rotieren f√ºr bessere Lesbarkeit
      updatePopupRotation(currentHeading);
      
      // Marker rotieren
      updateMarkerRotation(currentHeading);
      
      setTimeout(() => {
        if (map) {
          map.invalidateSize();
        }
      }, 300);
    } else {
      // Alles zur√ºcksetzen wenn Rotation aus ist
      updatePopupRotation(0);
      updateMarkerRotation(0);
    }
  }

  function updatePopupRotation(angle) {
    const popups = document.querySelectorAll('.leaflet-popup');
    popups.forEach(popup => {
      popup.style.transform = `rotate(${angle}deg)`;
      // Popup offen halten
      popup.classList.add('stay-open');
    });
  }

  function updateMarkerRotation(angle) {
    const markers = document.querySelectorAll('.leaflet-marker-icon');
    markers.forEach(marker => {
      marker.style.transform = `rotate(${angle}deg)`;
      marker.classList.add('marker-rotated');
    });
  }

  
        var marker = L.marker([49.10951, 11.68453], {
            icon: L.icon({
                iconUrl: 'icons/red-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>√úberflurhydrant</b><br>√úberflurhydrant Feuerwehrhaus<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10951,11.68453' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10951,11.68453' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10895, 11.68544], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Sch√∂ndorfer Str. 5<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10895,11.68544' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10895,11.68544' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10803, 11.68614], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Zum Spitzberg 3<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10803,11.68614' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10803,11.68614' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10752, 11.68542], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Kreuzung Zum Spitzberg / R√∂thenweg<br>Nenndurchmesser DN: 125.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10752,11.68542' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10752,11.68542' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10815, 11.68443], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant R√∂thenweg 13<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10815,11.68443' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10815,11.68443' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10693, 11.68444], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Zum Spitzberg 10<br>Nenndurchmesser DN: 100.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10693,11.68444' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10693,11.68444' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10738, 11.68313], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Sonnenring 14<br>Nenndurchmesser DN: 100.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10738,11.68313' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10738,11.68313' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10664, 11.68528], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Kiefergasse 5<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10664,11.68528' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10664,11.68528' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10597, 11.68546], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Rascher Str. 13<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10597,11.68546' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10597,11.68546' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.1055, 11.68611], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Rascher Str. 9<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.1055,11.68611' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.1055,11.68611' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10605, 11.6862], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant R√∂thenweg 6<br>Nenndurchmesser DN: 100.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10605,11.6862' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10605,11.6862' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10668, 11.68604], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant R√∂thenweg<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10668,11.68604' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10668,11.68604' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10786, 11.68775], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Hauptstra√üe 17<br>Nenndurchmesser DN: 125.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10786,11.68775' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10786,11.68775' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.1068, 11.68672], {
            icon: L.icon({
                iconUrl: 'icons/red-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>√úberflurhydrant</b><br>√úberflurhydrant Hauptstra√üe 28<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.1068,11.68672' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.1068,11.68672' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.1063, 11.68724], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Hauptstra√üe 21b<br>Nenndurchmesser DN: 125.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.1063,11.68724' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.1063,11.68724' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10557, 11.68756], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Hauptstra√üe 25<br>Nenndurchmesser DN: 125.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10557,11.68756' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10557,11.68756' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10483, 11.68749], {
            icon: L.icon({
                iconUrl: 'icons/red-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>√úberflurhydrant</b><br>√úberflurhydrant Hauptstra√üe 29<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10483,11.68749' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10483,11.68749' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10502, 11.68894], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Herrnrieder Str. 2<br>Nenndurchmesser DN: 100.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10502,11.68894' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10502,11.68894' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10279, 11.68877], {
            icon: L.icon({
                iconUrl: 'icons/red-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>√úberflurhydrant</b><br>√úberflurhydrant Eichlberger Str. 12<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10279,11.68877' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10279,11.68877' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10373, 11.6877], {
            icon: L.icon({
                iconUrl: 'icons/red-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>√úberflurhydrant</b><br>√úberflurhydrant Eichlberger Str. 3<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10373,11.6877' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10373,11.6877' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.1043, 11.68642], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Hauptstra√üe 35<br>Nenndurchmesser DN: 100.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.1043,11.68642' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.1043,11.68642' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10412, 11.68603], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Hauptstra√üe 37<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10412,11.68603' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10412,11.68603' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10355, 11.68542], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Hauptstra√üe 41<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10355,11.68542' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10355,11.68542' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10372, 11.68505], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Hauptstra√üe 46<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10372,11.68505' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10372,11.68505' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10288, 11.68749], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Eichlberger Str. 12<br>Nenndurchmesser DN: 125.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10288,11.68749' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10288,11.68749' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10367, 11.68839], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Eichlberger Str. 4<br>Nenndurchmesser DN: 100.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10367,11.68839' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10367,11.68839' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.11046, 11.67008], {
            icon: L.icon({
                iconUrl: 'icons/red-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>√úberflurhydrant</b><br>√úberflurhydrant √ñdberg 1<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.11046,11.67008' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.11046,11.67008' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.11063, 11.67348], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant √ñdberg 3<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.11063,11.67348' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.11063,11.67348' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.1111, 11.67341], {
            icon: L.icon({
                iconUrl: 'icons/red-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>√úberflurhydrant</b><br>√úberflurhydrant √ñdberg 4<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.1111,11.67341' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.1111,11.67341' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.11035, 11.6837], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Sportplatz<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.11035,11.6837' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.11035,11.6837' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.11208, 11.68469], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Kreuzung Reitstra√üe/Spanbergweg<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.11208,11.68469' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.11208,11.68469' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.11304, 11.68592], {
            icon: L.icon({
                iconUrl: 'icons/red-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>√úberflurhydrant</b><br>√úberflurhydrant Gabelung Reitstra√üe/Winner Str.<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.11304,11.68592' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.11304,11.68592' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.11292, 11.68668], {
            icon: L.icon({
                iconUrl: 'icons/red-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>√úberflurhydrant</b><br>√úberflurhydrant Bush√§uschen Schn√∂dorf<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.11292,11.68668' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.11292,11.68668' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.11328, 11.68606], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Winner Str. 1<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.11328,11.68606' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.11328,11.68606' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.11447, 11.6874], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Winner Str. 6<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.11447,11.6874' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.11447,11.6874' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.11339, 11.68766], {
            icon: L.icon({
                iconUrl: 'icons/red-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>√úberflurhydrant</b><br>√úberflurhydrant Reitstra√üe 20<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.11339,11.68766' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.11339,11.68766' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.11098, 11.68577], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Hohe Trift 5<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.11098,11.68577' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.11098,11.68577' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.11124, 11.68644], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Hohe Trift 2, Einm√ºndung Spanbergweg<br>Nenndurchmesser DN: 150.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.11124,11.68644' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.11124,11.68644' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.11065, 11.68653], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Hauptstra√üe 1<br>Nenndurchmesser DN: 150.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.11065,11.68653' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.11065,11.68653' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.11, 11.68699], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Hauptstra√üe 3<br>Nenndurchmesser DN: 100.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.11,11.68699' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.11,11.68699' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.1091, 11.68704], {
            icon: L.icon({
                iconUrl: 'icons/red-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>√úberflurhydrant</b><br>√úberflurhydrant Hauptstra√üe 10<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.1091,11.68704' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.1091,11.68704' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10941, 11.68767], {
            icon: L.icon({
                iconUrl: 'icons/yellow-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Wasserbeh√§lter</b><br>L√∂schwasserbeh√§lter Talweg, Einm√ºndung Pfarrgasse<br>Nenndurchmesser DN: nan mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10941,11.68767' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10941,11.68767' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10881, 11.68816], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Pfarrgasse 4<br>Nenndurchmesser DN: 100.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10881,11.68816' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10881,11.68816' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.11375, 11.69697], {
            icon: L.icon({
                iconUrl: 'icons/red-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>√úberflurhydrant</b><br>√úberflurhydrant Rofen<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.11375,11.69697' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.11375,11.69697' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.11399, 11.69562], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Rofen<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.11399,11.69562' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.11399,11.69562' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10078, 11.68323], {
            icon: L.icon({
                iconUrl: 'icons/red-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>√úberflurhydrant</b><br>√úberflurhydrant Ziegelh√ºtte 1<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10078,11.68323' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10078,11.68323' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10849, 11.68725], {
            icon: L.icon({
                iconUrl: 'icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Unterflurhydrant</b><br>Unterflurhydrant Kirche<br>Nenndurchmesser DN: 80.0 mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10849,11.68725' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10849,11.68725' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.092199, 11.70373], {
            icon: L.icon({
                iconUrl: 'icons/green-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Rettungspunkt</b><br>Rettungspunkt Schafsee Hamberg/Eichlberg<br>Nenndurchmesser DN: nan mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.092199,11.70373' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.092199,11.70373' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.086695, 11.66433953], {
            icon: L.icon({
                iconUrl: 'icons/green-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Rettungspunkt</b><br>Rettungspunkt NM-2131 Langenthonhausen<br>Nenndurchmesser DN: nan mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.086695,11.66433953' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.086695,11.66433953' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.10529568, 11.716126], {
            icon: L.icon({
                iconUrl: 'icons/green-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Rettungspunkt</b><br>Rettungspunkt Feuerwehrhaus Herrnried<br>Nenndurchmesser DN: nan mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.10529568,11.716126' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.10529568,11.716126' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.11173709, 11.66721575], {
            icon: L.icon({
                iconUrl: 'icons/green-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Rettungspunkt</b><br>Rettungspunkt NM-2171 √ñdberg<br>Nenndurchmesser DN: nan mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.11173709,11.66721575' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.11173709,11.66721575' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);
        var marker = L.marker([49.12040024, 11.71188973], {
            icon: L.icon({
                iconUrl: 'icons/green-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup(`<b>Rettungspunkt</b><br>Rettungspunkt NM-2189 B8 Parkplatz<br>Nenndurchmesser DN: nan mm<br>FF Hamberg<br><a href='https://maps.apple.com/?daddr=49.12040024,11.71188973' target='_blank'>Apple Karten</a><br><a href='https://maps.google.com/?daddr=49.12040024,11.71188973' target='_blank'>Google Maps</a>`).on('click', function(e) {
            map.setView(this.getLatLng(), 18);
            // Popup-Rotation nach dem √ñffnen anwenden
            setTimeout(() => {
                if (mapRotationEnabled) {
                    const rotationAngle = isIOS ? currentHeading : -currentHeading;
                    updatePopupRotation(-rotationAngle);
                }
            }, 100);
        });
        hydrantMarkers.push(marker);

  function gotoUserLocation() {
    if (userMarker) {
      map.setView(userMarker.getLatLng(), 17);
    } else {
      startLocationTracking();
    }
  }

  function startLocationTracking() {
    if ("geolocation" in navigator) {
      const options = {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 30000
      };
      
      watchId = navigator.geolocation.watchPosition(
        onLocationSuccess,
        onLocationError,
        options
      );
    } else {
      alert('Geolocation wird von diesem Browser nicht unterst√ºtzt.');
    }
  }

  function onLocationSuccess(position) {
    const lat = position.coords.latitude;
    const lng = position.coords.longitude;
    const accuracy = position.coords.accuracy;
    const altitude = position.coords.altitude;
    const altitudeAccuracy = position.coords.altitudeAccuracy;
    
    userPosition = { lat, lng };
    currentAccuracy = Math.round(accuracy);
    
    // H√∂henanzeige mit verbesserter Behandlung
    if (altitude !== null && altitude !== undefined) {
      currentAltitude = Math.round(altitude);
      const altAccText = altitudeAccuracy ? ` (¬±${Math.round(altitudeAccuracy)}m)` : '';
      document.getElementById('altitude-indicator').textContent = 
        `H√∂he: ${currentAltitude}m${altAccText}`;
    } else {
      // Versuche H√∂he √ºber externe API zu ermitteln (falls verf√ºgbar)
      document.getElementById('altitude-indicator').textContent = 'H√∂he: GPS nicht verf√ºgbar';
      
      // Optional: H√∂he √ºber Elevation API ermitteln
      fetchElevationData(lat, lng);
    }
    
    // UI Updates
    const gpsAccuracy = accuracy < 10 ? 'üü¢' : accuracy < 50 ? 'üü°' : 'üî¥';
    document.getElementById('accuracy-indicator').textContent = `${gpsAccuracy} GPS: ${currentAccuracy}m`;
    
    if (userMarker) map.removeLayer(userMarker);
    if (cone) map.removeLayer(cone);
    if (accuracyCircle) map.removeLayer(accuracyCircle);
    
    accuracyCircle = L.circle([lat, lng], {
      radius: accuracy,
      color: emergencyMode ? '#ff4444' : '#4285f4',
      fillColor: emergencyMode ? '#ff4444' : '#4285f4',
      fillOpacity: 0.1,
      weight: emergencyMode ? 3 : 1
    }).addTo(map);
    
    userMarker = L.circleMarker([lat, lng], { 
      radius: emergencyMode ? 12 : 8, 
      color: emergencyMode ? '#ff4444' : '#4285f4', 
      fillColor: emergencyMode ? '#ff4444' : '#4285f4', 
      fillOpacity: 0.8,
      weight: emergencyMode ? 4 : 2
    }).addTo(map).bindPopup(`
      <b>Meine Position</b><br>
      Koordinaten: ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>
      ${altitude ? `H√∂he: ${Math.round(altitude)} m<br>` : ''}
      Genauigkeit: ${Math.round(accuracy)} m
    `);
    
    // Richtungskegel - zeigt immer nach oben (Norden)
    cone = L.polygon(getConePoints([lat, lng], 0), { 
      color: emergencyMode ? '#ff4444' : '#ff6b35', 
      fillColor: emergencyMode ? '#ff4444' : '#ff6b35', 
      fillOpacity: emergencyMode ? 0.5 : 0.3, 
      weight: emergencyMode ? 3 : 2 
    }).addTo(map);
    
    // N√§chsten Hydranten finden und anzeigen
    findAndShowNearestHydrant();
    
    if (!watchId || map.getZoom() < 15) {
      map.setView([lat, lng], 17);
    }
  }

  function onLocationError(error) {
    console.error('Geolocation error:', error);
    const statusEl = document.getElementById('compass-status');
    switch(error.code) {
      case error.PERMISSION_DENIED:
        statusEl.textContent = 'Position: Zugriff verweigert';
        break;
      case error.POSITION_UNAVAILABLE:
        statusEl.textContent = 'Position: Nicht verf√ºgbar';
        break;
      case error.TIMEOUT:
        statusEl.textContent = 'Position: Timeout';
        break;
    }
  }

  function getConePoints(center, angleDeg, radius = 40, spread = 45) {
    const [lat, lng] = center;
    const angleRad = (angleDeg * Math.PI) / 180;
    const spreadRad = (spread * Math.PI) / 180;
    const points = [[lat, lng]];
    
    for (let a = -spreadRad / 2; a <= spreadRad / 2; a += spreadRad / 15) {
      const dx = radius * Math.sin(angleRad + a);
      const dy = radius * Math.cos(angleRad + a);
      const dLat = dy / 111111;
      const dLng = dx / (111111 * Math.cos((lat * Math.PI) / 180));
      points.push([lat + dLat, lng + dLng]);
    }
    
    return points;
  }

  function updateHeading(heading) {
    currentHeading = heading;
    const degreeDisplay = document.getElementById('degree-indicator');
    
    if (degreeDisplay) {
      degreeDisplay.innerText = `${Math.round(heading)}¬∞`;
    }
    
    if (cone && userMarker) {
      const userLatLng = userMarker.getLatLng();
      // Flashlight zeigt immer nach oben (Norden = 0¬∞), unabh√§ngig von Kartenrotation
      cone.setLatLngs(getConePoints([userLatLng.lat, userLatLng.lng], 0));
    }
    
    updateMapRotation();
  }

  function setupOrientationListener() {
    const compassStatus = document.getElementById('compass-status');
    
    function handleOrientation(event) {
      let heading = null;
      
      if (event.alpha !== null) {
        if (isIOS && event.webkitCompassHeading !== undefined) {
          heading = event.webkitCompassHeading;
        } else if (event.alpha !== null) {
          heading = 360 - event.alpha;
          if (heading >= 360) heading -= 360;
          if (heading < 0) heading += 360;
        }
        
        if (heading !== null) {
          updateHeading(heading);
          
          if (!compassActive) {
            compassActive = true;
            compassStatus.textContent = 'Kompass: Aktiv';
            compassStatus.style.backgroundColor = '#4CAF50';
            compassStatus.style.color = 'white';
          }
        }
      }
    }
    
    if (window.DeviceOrientationEvent) {
      window.addEventListener('deviceorientation', handleOrientation, true);
      
      if ('ondeviceorientationabsolute' in window) {
        window.addEventListener('deviceorientationabsolute', handleOrientation, true);
      }
      
      if (isIOS) {
        window.addEventListener('webkitcompassneedscalibration', function(event) {
          alert('Ihr Kompass ben√∂tigt eine Kalibrierung. Bewegen Sie Ihr Ger√§t in einer Acht-Form.');
          event.preventDefault();
        }, true);
      }
    }
  }

  function requestOrientationPermissionIfNeeded() {
    const compassStatus = document.getElementById('compass-status');
    
    // F√ºr iOS 13+ Berechtigung erforderlich
    if (typeof DeviceOrientationEvent !== "undefined" && 
        typeof DeviceOrientationEvent.requestPermission === "function") {
      
      // Benutzer √ºber Berechtigung informieren
      if (confirm('Diese App ben√∂tigt Zugriff auf den Kompass f√ºr die Richtungsanzeige. Erlauben?')) {
        DeviceOrientationEvent.requestPermission()
          .then(permissionState => {
            if (permissionState === "granted") {
              setupOrientationListener();
              compassStatus.textContent = 'Kompass: Berechtigung erteilt';
              startLocationTracking();
            } else {
              compassStatus.textContent = 'Kompass: Berechtigung verweigert';
              alert('Kompass-Berechtigung verweigert. Die Richtungsanzeige ist nicht verf√ºgbar.');
            }
          })
          .catch(err => {
            console.error('Fehler bei Kompass-Berechtigung:', err);
            compassStatus.textContent = 'Kompass: Fehler';
          });
      } else {
        compassStatus.textContent = 'Kompass: Nicht aktiviert';
      }
    } else {
      // F√ºr Android und √§ltere iOS Versionen
      setupOrientationListener();
      startLocationTracking();
    }
  }

  function fetchElevationData(lat, lng) {
    // Vereinfachte H√∂henermittlung √ºber Open-Topo-Data API
    // In einer Produktionsumgebung sollten Sie einen zuverl√§ssigeren Service verwenden
    fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`)
      .then(response => response.json())
      .then(data => {
        if (data.results && data.results[0]) {
          const elevation = Math.round(data.results[0].elevation);
          document.getElementById('altitude-indicator').textContent = 
            `H√∂he: ${elevation}m (Web-API)`;
        }
      })
      .catch(err => {
        console.warn('H√∂hendaten-Abruf fehlgeschlagen:', err);
        document.getElementById('altitude-indicator').textContent = 'H√∂he: Nicht verf√ºgbar';
      });
  }

  function handleResize() {
    if (map) {
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
    }
  }

  window.addEventListener('resize', handleResize);
  window.addEventListener('orientationchange', function() {
    setTimeout(handleResize, 500);
  });

  window.addEventListener('load', function() {
    setTimeout(function() {
      requestOrientationPermissionIfNeeded();
    }, 1000);
  });

  let touchActivated = false;
  document.addEventListener('touchstart', function() {
    if (!touchActivated && !compassActive) {
      touchActivated = true;
      requestOrientationPermissionIfNeeded();
    }
  }, { once: true });

  window.addEventListener('beforeunload', function() {
    if (watchId) {
      navigator.geolocation.clearWatch(watchId);
    }
  });

  setTimeout(() => {
    map.invalidateSize();
  }, 100);

  // Event Listener f√ºr persistente Popups
  map.on('popupopen', function(e) {
    openPopup = e.popup;
    
    // Popup-Rotation anwenden
    if (mapRotationEnabled) {
      setTimeout(() => {
        updatePopupRotation(currentHeading);
      }, 50);
    }
    
    // Popup persistent machen
    setTimeout(() => {
      const popupElement = e.popup.getElement();
      if (popupElement) {
        popupElement.classList.add('stay-open');
        
        // Verhindere automatisches Schlie√üen
        popupElement.addEventListener('click', (event) => {
          event.stopPropagation();
        });
      }
    }, 100);
  });

  map.on('popupclose', function(e) {
    openPopup = null;
  });

  // Click-Handler f√ºr Karte (au√üerhalb von Popups)
  map.on('click', function(e) {
    // Nur schlie√üen wenn nicht auf Popup geklickt wurde
    if (openPopup && !e.originalEvent.target.closest('.leaflet-popup')) {
      map.closePopup(openPopup);
    }
  });

  // Feuerwehr-spezifische Funktionen
  function toggleEmergencyMode() {
    emergencyMode = !emergencyMode;
    const toggleBtn = document.getElementById('emergency-toggle');
    const body = document.body;
    
    if (emergencyMode) {
      toggleBtn.classList.add('active');
      toggleBtn.textContent = 'üö® AKTIV';
      body.classList.add('emergency-mode');
      
      // Alle Marker und Elemente in Notfall-Modus umschalten
      if (userMarker) {
        userMarker.setStyle({
          radius: 12,
          color: '#ff4444',
          fillColor: '#ff4444',
          weight: 4
        });
      }
      
      if (accuracyCircle) {
        accuracyCircle.setStyle({
          color: '#ff4444',
          fillColor: '#ff4444',
          weight: 3
        });
      }
      
      if (cone) {
        cone.setStyle({
          color: '#ff4444',
          fillColor: '#ff4444',
          fillOpacity: 0.5,
          weight: 3
        });
      }
      
      // Automatisch Taschenlampe mit Blinkmodus aktivieren
      if (!flashlightActive) {
        toggleFlashlight();
      } else if (flashlightActive) {
        startEmergencyFlash();
      }
      
    } else {
      toggleBtn.classList.remove('active');
      toggleBtn.textContent = 'üö® Notfall';
      body.classList.remove('emergency-mode');
      
      // Blinkmodus stoppen
      stopEmergencyFlash();
      
      // Zur√ºck zum normalen Modus
      if (userMarker) {
        userMarker.setStyle({
          radius: 8,
          color: '#4285f4',
          fillColor: '#4285f4',
          weight: 2
        });
      }
      
      if (accuracyCircle) {
        accuracyCircle.setStyle({
          color: '#4285f4',
          fillColor: '#4285f4',
          weight: 1
        });
      }
      
      if (cone) {
        cone.setStyle({
          color: '#ff6b35',
          fillColor: '#ff6b35',
          fillOpacity: 0.3,
          weight: 2
        });
      }
    }
  }

  function findNearestHydrant() {
    if (!userPosition) {
      alert('Position noch nicht verf√ºgbar. Bitte warten...');
      return;
    }
    
    let nearest = null;
    let minDistance = Infinity;
    
    hydrantMarkers.forEach(marker => {
      const hydrantPos = marker.getLatLng();
      const distance = calculateDistance(
        userPosition.lat, userPosition.lng,
        hydrantPos.lat, hydrantPos.lng
      );
      
      if (distance < minDistance) {
        minDistance = distance;
        nearest = marker;
      }
    });
    
    if (nearest) {
      map.setView(nearest.getLatLng(), 18);
      nearest.openPopup();
      
      // Linie zum n√§chsten Hydranten zeichnen
      if (nearestHydrantLine) {
        map.removeLayer(nearestHydrantLine);
      }
      
      nearestHydrantLine = L.polyline([
        [userPosition.lat, userPosition.lng],
        nearest.getLatLng()
      ], {
        color: emergencyMode ? '#ff4444' : '#4CAF50',
        weight: emergencyMode ? 4 : 3,
        opacity: 0.8,
        dashArray: '10, 5'
      }).addTo(map);
      
      document.getElementById('nearest-hydrant').textContent = 
        `N√§chster: ${Math.round(minDistance)} m`;
    }
  }

  function findAndShowNearestHydrant() {
    if (!userPosition || hydrantMarkers.length === 0) return;
    
    let minDistance = Infinity;
    
    hydrantMarkers.forEach(marker => {
      const hydrantPos = marker.getLatLng();
      const distance = calculateDistance(
        userPosition.lat, userPosition.lng,
        hydrantPos.lat, hydrantPos.lng
      );
      
      if (distance < minDistance) {
        minDistance = distance;
      }
    });
    
    document.getElementById('nearest-hydrant').textContent = 
      `N√§chster: ${Math.round(minDistance)} m`;
  }

  function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371000; // Erdradius in Metern
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function captureScreenshot() {
    // HTML2Canvas alternative f√ºr Screenshots
    if (navigator.share) {
      navigator.share({
        title: 'Hydrantenkarte Screenshot',
        text: `Position: ${userPosition ? userPosition.lat.toFixed(6) + ', ' + userPosition.lng.toFixed(6) : 'unbekannt'}`,
        url: window.location.href
      }).catch(console.error);
    } else {
      // Fallback: Koordinaten in Zwischenablage
      const coords = userPosition ? 
        `${userPosition.lat.toFixed(6)}, ${userPosition.lng.toFixed(6)}` : 
        'Position unbekannt';
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(coords).then(() => {
          alert('Koordinaten in Zwischenablage kopiert: ' + coords);
        });
      } else {
        alert('Aktuelle Position: ' + coords);
      }
    }
  }
</script>
</body>
</html>